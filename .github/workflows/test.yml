name: Test

on:
  pull_request:

permissions:
  contents: read
  pull-requests: write

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run JVM tests
        run: ./gradlew jvmTest

      - name: Generate Kover XML Report
        run: ./gradlew koverXmlReport

      - name: Generate Coverage Report
        id: coverage
        run: |
          # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¤å®šé–¢æ•°
          get_status() {
            local percent=$1
            if awk "BEGIN {exit !($percent >= 90)}"; then
              echo "âœ… Excellent"
            elif awk "BEGIN {exit !($percent >= 80)}"; then
              echo "âœ… Good"
            elif awk "BEGIN {exit !($percent >= 60)}"; then
              echo "âš ï¸ Fair"
            else
              echo "âŒ Low"
            fi
          }

          get_total_status() {
            local percent=$1
            if awk "BEGIN {exit !($percent >= 80)}"; then
              echo "âœ…"
            elif awk "BEGIN {exit !($percent >= 60)}"; then
              echo "âš ï¸"
            else
              echo "âŒ"
            fi
          }

          # ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
          REPORT_FILE="coverage_report.md"
          echo "## ğŸ“Š Code Coverage Report" > $REPORT_FILE
          echo "" >> $REPORT_FILE
          echo "| Module | Coverage | Status |" >> $REPORT_FILE
          echo "|--------|----------|--------|" >> $REPORT_FILE

          TOTAL_COVERED=0
          TOTAL_MISSED=0

          # ãƒ†ã‚¹ãƒˆã®ã‚ã‚‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã¿å¯¾è±¡
          MODULES="core/data core/domain core/network feature/home feature/search feature/viewer"

          for MODULE in $MODULES; do
            REPORT="./$MODULE/build/reports/kover/report.xml"
            if [ -f "$REPORT" ]; then
              # XMLã‹ã‚‰LINEã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’æŠ½å‡ºï¼ˆãƒ¬ãƒãƒ¼ãƒˆå…¨ä½“ã®åˆè¨ˆ = æœ€å¾Œã®<counter type="LINE">ï¼‰
              LINE_DATA=$(grep 'type="LINE"' "$REPORT" | tail -1)
              COVERED=$(echo "$LINE_DATA" | sed -n 's/.*covered="\([0-9]*\)".*/\1/p')
              MISSED=$(echo "$LINE_DATA" | sed -n 's/.*missed="\([0-9]*\)".*/\1/p')

              if [ -n "$COVERED" ] && [ -n "$MISSED" ]; then
                TOTAL=$((COVERED + MISSED))
                if [ "$TOTAL" -gt 0 ]; then
                  PERCENT=$(awk "BEGIN {printf \"%.1f\", $COVERED * 100 / $TOTAL}")
                  STATUS=$(get_status $PERCENT)
                  echo "| \`$MODULE\` | ${PERCENT}% ($COVERED/$TOTAL) | $STATUS |" >> $REPORT_FILE
                  TOTAL_COVERED=$((TOTAL_COVERED + COVERED))
                  TOTAL_MISSED=$((TOTAL_MISSED + MISSED))
                fi
              fi
            fi
          done

          echo "" >> $REPORT_FILE
          TOTAL_LINES=$((TOTAL_COVERED + TOTAL_MISSED))
          if [ "$TOTAL_LINES" -gt 0 ]; then
            TOTAL_PERCENT=$(awk "BEGIN {printf \"%.1f\", $TOTAL_COVERED * 100 / $TOTAL_LINES}")
            TOTAL_STATUS=$(get_total_status $TOTAL_PERCENT)
            echo "**Total: ${TOTAL_PERCENT}%** ($TOTAL_COVERED/$TOTAL_LINES lines) $TOTAL_STATUS" >> $REPORT_FILE
          fi

          # GitHub Step Summaryã«ã‚‚å‡ºåŠ›
          cat $REPORT_FILE >> $GITHUB_STEP_SUMMARY

      - name: Add Coverage Comment to PR
        if: github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # æ—¢å­˜ã®ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¤œç´¢
          COMMENT_ID=$(gh api repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments \
            --jq '.[] | select(.body | startswith("## ğŸ“Š Code Coverage Report")) | .id' | head -1)

          if [ -n "$COMMENT_ID" ]; then
            # æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°
            gh api repos/${{ github.repository }}/issues/comments/$COMMENT_ID \
              -X PATCH \
              -F body=@coverage_report.md
          else
            # æ–°ã—ã„ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
            gh pr comment ${{ github.event.pull_request.number }} --body-file coverage_report.md
          fi