name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

jobs:
  # PR作成/更新時の自動レビュー
  auto-review:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: Run Claude Code Review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            **IMPORTANT: You MUST respond in Japanese.**

            このPRをレビューし、CLAUDE.mdとagent-docs/の規約に従って以下の観点でフィードバックを提供してください:

            1. Clean Architecture + MVIパターン準拠
            2. モジュール依存関係（フィーチャー間依存禁止、core:domain経由）
            3. 命名規則準拠（agent-docs/NAMING_CONVENTION.md）
            4. テスト規約準拠（agent-docs/TESTING_CONVENTION.md）

            詳細な規約はCLAUDE.mdとagent-docs/を参照してください。

            レビュー形式（日本語で出力）:
            ### レビューサマリー
            ### 準拠状況
            ### 推奨事項

            Use `gh pr comment` for top-level feedback.
            Use `mcp__github_inline_comment__create_inline_comment` to highlight specific code issues.

          claude_args: |
            --model claude-opus-4-5-20251101
            --max-turns 15
            --allowedTools "mcp__github_inline_comment__create_inline_comment,Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Read,Glob,Grep"

  # /claude review コマンドでの手動レビュー
  manual-review:
    if: |
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request &&
       contains(github.event.comment.body, '/claude review')) ||
      (github.event_name == 'pull_request_review_comment' &&
       contains(github.event.comment.body, '/claude review'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: Run Claude Code Review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          trigger_phrase: "/claude review"
          claude_args: |
            --model claude-opus-4-5-20251101
            --max-turns 15
            --allowedTools "mcp__github_inline_comment__create_inline_comment,Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Read,Glob,Grep"
            --system-prompt "**IMPORTANT: You MUST respond in Japanese.**

            このPRをレビューし、CLAUDE.mdとagent-docs/の規約に従って以下の観点でフィードバックを提供してください:

            1. Clean Architecture + MVIパターン準拠
            2. モジュール依存関係（フィーチャー間依存禁止、core:domain経由）
            3. 命名規則準拠（agent-docs/NAMING_CONVENTION.md）
            4. テスト規約準拠（agent-docs/TESTING_CONVENTION.md）

            詳細な規約はCLAUDE.mdとagent-docs/を参照してください。

            レビュー形式（日本語で出力）:
            ### レビューサマリー
            ### 準拠状況
            ### 推奨事項

            Use gh pr comment for top-level feedback.
            Use mcp__github_inline_comment__create_inline_comment to highlight specific code issues."